[TOC]
# 第1章 深入Web请求过程
 
## 1.1 B/S网络架构概述
B/S架构好处：
1. 客户端使用统一Browser
2. 服务商基于统一HTTP
### 图1-1 CDN架构图
 
## 1.2 如何发起一个请求
> 发起一个HTTP连接本质上就是建立一个Socket连接
 
- HttpClient (Java工具)
- curl+URL (Linux命令)
 
## 1.3 HTTP解析
### 表1-3 HTTP请求头&响应头&状态码
 
### 1.3.2 浏览器缓存机制
- Ctrl+F5增加`Pragma:no-cache`和`Cache-Control:no-cache`配置项
- Expires：超过这个时间值后，缓存的内容将失效
- Last-Modified/Etag：服务器上资源的最后修改时间(304状态码为最新)；Etag是编号，不适于多服务器
 
## 1.4 DNS域名解析
### 1.4.1 DNS域名解析过程
1. 浏览器检查缓存
2. 系统etc\hosts文件指定
3. Local DNS Server (LDNS) 本地域名服务器，路由、机构、电信
4. Root DNS Server 根域名服务器
5. gTLD Server 国际顶级域名，根域名服务器返回LDNS一个所查询域的主域名服务器地址，如.cmd、.cn，全球只有13台左右
6. LDNS再向上一步返回的gTLD服务器发送请求
7. gTLD服务器接受请求并返回此域名对应的Name Server域名服务器地址(域名提供商)
8. Name Server 域名服务器查询存储的域名和IP映射关系表，连同一个TTL值返回给DNS Server域名服务器 (可能会有多级或GTM负载均衡控制)
9. LDNS会缓存这个域名和IP的对应关系，缓存时间由TTL值控制
10. 解析结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程结束。
 
### 1.4.2 跟踪域名解析过程
`nslookup`命令
Linux: `dig` +`printcmd` +`trace`
 
### 1.4.3 清除缓存的域名
- Windows: `ipconfig/flushdns`
- Linux: `/etc/init.d/nscd restart`
- 重启
- Java应用中JVM缓存DNS`%JAVA_HOME\lib\security\java.security%`
  - `networkaddress.cache.ttl`-1 (永不失效)
  - `networkaddress.cache.negative.ttl`10 (缓存10秒)
  - `-Dsun.net.inetaddr.ttl=xxx`通过InetAddress类动态修改，必须单例模式
 
### 1.4.4 几种域名解析方式
+ A记录，Address用来指定域名对应的IP地址，多个域名解析到一个IP地址，不能将一个域名解析到多个IP地址
+ MX记录，Mail Exchange某个域名下邮件服务器指向自己Mail Server
+ CNAME记录，Canonical Name (域名别名解析)
+ NS记录，为某个域名指定DNS解析服务器
+ TXT记录，为某个主机名或域名设置说明文字
 
## 1.5 CDN工作机制
> 内容分布网络（Content Delivery Network），它是构筑在现在Internet上的一种先进的流量分配网络 。
 
CDN = 镜像（Mirror）+缓存（Cache）+整体负载均衡（GSLB）
 
* 可扩展（Scalability）。
  * 性能可扩展性：应对新增的大量数据、用户和事务的扩展能力
  * 成本可扩展性：用低廉的运营成本提供动态的服务能力和高质量的内容分发
* 安全性（Security）。强调提供物理设备、网络 、软件、数据和服务过程的安全性，（趋势）减少因为DDoS攻击或者其他恶意行为造成的商业网络的业务中断。
* 可靠性、响应和执行（Reliability、Responsiveness和Performance）。服务可用性指能够处理可能的故障和用户体验下降的问题，通过负载均衡及时提供网络的容错机制。
 
### 1.5.1 CDN架构
#### 图1-16 Web请求过程
 
### 1.5.2 负载均衡（Local Balance）
1. 链路负载均衡，由Global DNS Server完成
   - 优点：用户直接访问目标服务器，不需要经过代理，速度更快
   - 缺点：用户本地和Local DNS Server都有缓存，一旦某台Web Server挂掉，很难及时更新用户的域名解析结构
 
2. 集群负载均衡
   1. 硬件负载均衡（F5）
      - 优点：功能性能非常好，能够直接通过智能交换机实现，处理能力更强，而且与系统无关，负载性能强，更适用于一大堆设备、大访问量、简单应用
      - 缺点：价格非常贵，一主一备，不支持动态扩容，配置冗余，无法有效掌握服务器及应用状态
   2. 软件负载均衡（Nginx）
      - 优点：高性能的 HTTP和反向代理服务器，同时支持作为IMAP/POP3/SMTP代理服务器，基于系统与应用的负载均衡，能够更好地根据系统与应用的状况来分配负载。
      - 缺点：负载能力受服务器本身性能的影响，性能越好，负载能力越大。
3. 操作系统负载均衡
   软中断或硬件中断来达到负载均衡，如设置多队列网卡
 
### 1.5.3 CDN动态加速
> 在CDN的DNS解析中通过动态的链路探测来寻找回源最好的一条路径，然后通过DNS的调度将所有请求调度到选定的这条路径上回源，从而加速用户访问的效率。
 
 
 
 
# 第2章 深入分析Java I/O 的工作机制
 
## 2.1 Java的I/O类库的基本架构
 
java.io：前两组主要是传输数据的数据格式，后两组主要是传输数据的方式。
 
* 基于字节操作的I/O接口：InputStream和OutputStream
* 基于字符操作的I/O接口：Writer和Reader
* 基于磁盘操作的I/O接口：File
* 基于网络操作的I/O接口：Socket
 
## 2.2 磁盘I/O工作机制
 
1. 标准访问文件的方式
 
   - 访问文件方式：应用程序调用read()接口，操作系统检查在内核的高速缓存中有没有数据，有就直接返回，没有则从磁盘中读取，然后缓存在操作系统的缓存中。
   - 写入文件方式：应用程序调用write()接口，将数据从用户地址空间复制到内核地址空间的缓存中就完成，至于什么时候再写到磁盘中由操作系统决定，除非显式地调用了sync同步命令。
 
2. 直接I/O的方式
 
   直接I/O与异步I/O结合使用会得到比较好的性能。
 
3. 同步访问文件的方式
 
   性能比较差，适合对数据安全性要求比较高的场景中才会使用，硬件都是定制的
 
4. 异步访问文件的方式
 
   可以明显提高应用程序的效率，不会阻塞等待。
 
5. 内存映射的方式
 
   操作系统将内存中的某一块区域与磁盘中的文件关联起来，当要访问内存中的一段数据时，转换为访问文件的某一段数据，同样是减少数据从内核空间缓存到用户空间缓存的数据复制操作。
 
### 2.2.3 Java序列化技术
 
Java序列化就是将一个对象转化成一串二进制表示的字节数组，通过保存或转移这些字节数据来达到持久化的目的。需要持久化，对象必须继承`java.io.Serializable`接口。反序列化则必须有原始类作为模板，才能将这个对象还原。
 
* 当父类继承Serializable接口时，所有子类都可以被序列化
* 子类实现了Serializeble接口，子类能正确序列化。父类没有，父类中的属性不能序列化（不报错，数据会丢失）
* 如果序列化的属性是对象，则这个对象也必须实现Serializeble接口，否则会报错。
* 在反序列化时，如果对象的属性有修改或删减，则修改的部分属性会丢失，但不会报错。
* 在反序列化时，如果serialVersionUID被修改，则反序列化时会失败。
 
## 2.3 网络I/O工作机制
 
### 2.3.2 影响网络传输的因素
 
- 网络带宽
- 传输距离
- TCP拥塞控制
 
# 2.4 NIO的工作方式
 
> NIO核心概念：Channel和Selector
 
### 图2-16 基于NIO的Socket请求的处理过程
 
# 2.5 I/O调优
 
## 2.5.1 磁盘I/O调优
 
1. 性能检测
2. 提升I/O性能
   - 增加缓存，减少磁盘访问次数。
   - 优化磁盘的管理系统，设计最优的磁盘方式策略，以及磁盘的寻址策略，这是在底层操作系统层面考虑的。
   - 设计合理的磁盘存储数据块，以及访问这些数据块的策略，这是在应用层面考虑的。例如可以有寻址索引、异步和非阻塞的方式加快磁盘的访问速度。
   - 应用合理的RAID策略提升磁盘I/O。
 
## 2.5.2 TCP网络参数调优
 
建立TCP连接必须知道对方IP和未被使用的端口号，32位操作系统端口号通常是两字节，只有2<sup>16</sup>=65535个，操作系统0~1024是受保护的，Linux中查看/proc/sys/net/ipv4/ip_local_port_range
 
### 表2-4 调优参数
 
## 2.5.3 网络I/O优化
 
- 减少网络交互的次数
- 减少网络传输数据量的大小
- 尽量减少编码
 
交互场景：
 
1. 同步与异步
2. 阻塞与非阻塞
3. 两种方式的组合：同步阻塞、同步非阻塞、异步阻塞、异步非阻塞
 
### 表2-5 4种组合方式及性能分析
 
## 2.6 设计模式解析之适配器模式
 
### 图2-25 中的各角色说明
 
- Target（目标接口）：所要转换的所期待的接口
- Adaptee（源角色）：需要适配的接口
- Adapter（适配器）：将源接口适配成目标接口，继承源接口，实现目标接口
 
## 2.7 设计模式解析之装饰器模式
 
- Component：抽象组件角色，定义一组抽象的接口，规定这个装饰组件都有哪些功能
- ConcreteComponent：实现这个抽象组件的所有功能
- Decorator：装饰器角色，它持有一个Component对象实例的引用，定义一个与抽象组件一致的接口
- ConcreteDecorator：具体的装饰器实现者，负责实现装饰器角色定义的功能
 
## 2.8 适配器模式与装饰器模式的区别
 
别名都是包装模式（Wrapper）
 
适配器是将一个接口转变成另一接口达到重复使用的目的
 
装饰器是不改变被装饰对象的接口，增强原有的功能或改变原有处理方法而提升性能。
 
 
 
# 第3章 深入分析Java Web中的中文编码问题
 
# 第6章 深入分析ClassLoader工作机制


JVM加载class文件到内存有两种方式
- 隐式加载
- 显式加载

